name: Build and Release SecurePass

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka pyside6
          
      - name: Install Inno Setup
        run: |
          $url = "https://jrsoftware.org/download.php/is.exe"
          $output = "innosetup.exe"
          Invoke-WebRequest -Uri $url -OutFile $output
          Start-Process -FilePath $output -ArgumentList "/SILENT" -Wait
          Write-Host "Inno Setup installed successfully"
        shell: powershell
        
      - name: Build project
        run: .\build.bat
        
      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: SecurePassInstaller
          path: installer_output/SecurePassInstaller.exe
          
      - name: Create Windows Portable ZIP
        run: |
          Compress-Archive -Path dist\main.dist\main.exe -DestinationPath dist\SecurePass-Windows-Portable.zip -Force
        shell: powershell
        
      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: SecurePass-Windows-Portable
          path: dist/SecurePass-Windows-Portable.zip

  build-linux:
    name: Build for Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka pyside6
          
      - name: Build
        run: |
          chmod +x ./build.sh
          ./build.sh
          
      - name: Create Linux tar.gz
        run: |
          VERSION=${GITHUB_REF_NAME}
          mkdir -p package/SecurePass-$VERSION
          cp -r dist/main.dist package/SecurePass-$VERSION/
          cp -r installer package/SecurePass-$VERSION/ || true
          cp version.py package/SecurePass-$VERSION/ || true
          cp -r assets package/SecurePass-$VERSION/ || true
          tar -czf SecurePass-$VERSION-linux.tar.gz -C package SecurePass-$VERSION
          
      - name: Upload Linux Package
        uses: actions/upload-artifact@v4
        with:
          name: SecurePass-Linux-Package
          path: SecurePass-*-linux.tar.gz

  release:
    name: Create GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: List Files (debug)
        run: ls -R artifacts
        
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: SecurePass ${{ github.ref_name }}
          files: |
            artifacts/SecurePassInstaller/SecurePassInstaller.exe
            artifacts/SecurePass-Windows-Portable/SecurePass-Windows-Portable.zip
            artifacts/SecurePass-Linux-Package/SecurePass-*-linux.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}